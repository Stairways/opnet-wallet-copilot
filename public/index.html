<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OP_NET ‚Äî Wallet Copilot & DeFi Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080810;
    --surface: #0f0f1a;
    --surface2: #161625;
    --border: #252538;
    --orange: #f7931a;
    --orange-dim: rgba(247,147,26,0.1);
    --orange-glow: rgba(247,147,26,0.25);
    --green: #00e5a0;
    --green-dim: rgba(0,229,160,0.08);
    --red: #ff4d6a;
    --red-dim: rgba(255,77,106,0.1);
    --blue: #4d9fff;
    --blue-dim: rgba(77,159,255,0.1);
    --text: #eeeef5;
    --muted: #5a5a78;
    --accent: #a78bfa;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle noise texture overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 999;
    opacity: 0.4;
  }

  /* Grid bg */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(247,147,26,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(247,147,26,0.025) 1px, transparent 1px);
    background-size: 56px 56px;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
  nav {
    display: flex;
    align-items: center;
    padding: 0 32px;
    height: 64px;
    border-bottom: 1px solid var(--border);
    background: rgba(8,8,16,0.8);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 0;
  }

  .nav-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-right: 40px;
    flex-shrink: 0;
  }

  .nav-logo-icon {
    width: 32px; height: 32px;
    background: var(--orange);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    box-shadow: 0 0 16px var(--orange-glow);
    flex-shrink: 0;
  }

  .nav-logo-text {
    font-size: 16px;
    font-weight: 800;
    letter-spacing: -0.3px;
    white-space: nowrap;
  }

  .nav-logo-text span { color: var(--orange); }

  .nav-tabs {
    display: flex;
    gap: 4px;
    flex: 1;
  }

  .nav-tab {
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    border: 1px solid transparent;
    white-space: nowrap;
  }

  .nav-tab:hover { color: var(--text); }

  .nav-tab.active {
    background: var(--orange-dim);
    border-color: rgba(247,147,26,0.2);
    color: var(--orange);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-left: auto;
    flex-shrink: 0;
  }

  .network-pill {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 5px 10px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .network-pill.connected { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,229,160,0.2); }
  .network-pill.disconnected { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,77,106,0.2); }
  .network-pill.connecting { background: var(--orange-dim); color: var(--orange); border: 1px solid rgba(247,147,26,0.2); }
  .network-pill::before { content: '‚óè '; animation: blink 2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; padding: 40px 32px; max-width: 960px; margin: 0 auto; }
  .page.active { display: block; animation: fadeUp 0.4s ease both; }

  @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  @keyframes fadeDown { from{opacity:0;transform:translateY(-16px)} to{opacity:1;transform:translateY(0)} }

  /* ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ */
  .input-label { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; display: block; }

  .input-row { display: flex; gap: 10px; margin-bottom: 36px; }

  .addr-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .addr-input:focus { border-color: var(--orange); box-shadow: 0 0 0 3px var(--orange-dim); }
  .addr-input::placeholder { color: var(--muted); }

  .btn {
    background: var(--orange);
    color: #000;
    border: none;
    border-radius: 10px;
    padding: 13px 22px;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    white-space: nowrap;
  }

  .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--orange-glow); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

  .btn-ghost {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { border-color: var(--orange); box-shadow: none; color: var(--orange); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: rgba(247,147,26,0.15); }

  .card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 18px 22px;
    border-bottom: 1px solid var(--border);
  }

  .card-icon {
    width: 26px; height: 26px;
    background: var(--orange-dim);
    border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
  }

  .card-title { font-size: 13px; font-weight: 700; }

  .empty { padding: 32px; text-align: center; color: var(--muted); font-size: 12px; line-height: 1.8; }

  .badge {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    padding: 2px 8px;
    border-radius: 4px;
    letter-spacing: 0.5px;
  }

  .badge-purple { background: rgba(167,139,250,0.1); color: var(--accent); border: 1px solid rgba(167,139,250,0.2); }
  .badge-green { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,229,160,0.2); }
  .badge-orange { background: var(--orange-dim); color: var(--orange); border: 1px solid rgba(247,147,26,0.2); }
  .badge-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,77,106,0.2); }

  .error-bar { background: var(--red-dim); border: 1px solid rgba(255,77,106,0.3); border-radius: 10px; padding: 12px 16px; font-size: 12px; color: var(--red); margin-bottom: 20px; display: none; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 22px; position: relative; overflow: hidden; transition: border-color 0.2s, transform 0.2s; }
  .stat-card:hover { border-color: rgba(247,147,26,0.2); transform: translateY(-2px); }
  .stat-card::after { content: ''; position: absolute; top: 0; right: 0; width: 70px; height: 70px; background: radial-gradient(circle at top right, var(--orange-dim), transparent 70%); }
  .stat-label { font-size: 10px; font-weight: 600; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
  .stat-val { font-family: 'Space Mono', monospace; font-size: 24px; font-weight: 700; line-height: 1; margin-bottom: 5px; }
  .stat-val.orange { color: var(--orange); }
  .stat-val.green { color: var(--green); }
  .stat-sub { font-size: 11px; color: var(--muted); }

  /* ‚îÄ‚îÄ GRID LAYOUTS ‚îÄ‚îÄ */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .full-col { margin-bottom: 14px; }

  /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
  .chat-msgs { padding: 18px 22px; min-height: 200px; max-height: 260px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
  .msg { display: flex; gap: 8px; animation: fadeUp 0.3s ease both; }
  .msg.user { flex-direction: row-reverse; }
  .msg-av { width: 26px; height: 26px; border-radius: 7px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-top: 2px; }
  .msg.bot .msg-av { background: linear-gradient(135deg, var(--orange), #e55c00); }
  .msg.user .msg-av { background: var(--surface2); border: 1px solid var(--border); }
  .msg-bub { background: var(--surface2); border-radius: 10px; border-top-left-radius: 3px; padding: 9px 13px; font-size: 12px; line-height: 1.65; max-width: calc(100% - 34px); }
  .msg.user .msg-bub { background: var(--orange-dim); border: 1px solid rgba(247,147,26,0.12); border-radius: 10px; border-top-right-radius: 3px; }
  .hi { color: var(--orange); font-weight: 700; }
  .ok { color: var(--green); }
  .wn { color: #fbbf24; }

  .chips { padding: 0 18px 14px; display: flex; gap: 6px; flex-wrap: wrap; }
  .chip { font-size: 11px; padding: 4px 10px; border-radius: 16px; background: var(--surface2); border: 1px solid var(--border); color: var(--muted); cursor: pointer; transition: all 0.15s; }
  .chip:hover { border-color: var(--orange); color: var(--orange); }

  .chat-bar { padding: 14px 18px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
  .chat-in { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 13px; font-family: 'Syne', sans-serif; font-size: 12px; color: var(--text); outline: none; }
  .chat-in:focus { border-color: var(--orange); }
  .chat-in::placeholder { color: var(--muted); font-size: 11px; }
  .send-btn { background: var(--orange); border: none; border-radius: 8px; width: 36px; height: 36px; cursor: pointer; color: #000; font-size: 15px; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
  .send-btn:hover { transform: scale(1.08); }

  .typing { display: flex; align-items: center; gap: 4px; padding: 4px 0; }
  .typing span { width: 5px; height: 5px; background: var(--orange); border-radius: 50%; animation: bounce 1.2s infinite; }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,80%,100%{transform:translateY(0);opacity:0.4} 40%{transform:translateY(-5px);opacity:1} }

  /* ‚îÄ‚îÄ TOKEN / TX ROWS ‚îÄ‚îÄ */
  .list-row { display: flex; align-items: center; padding: 13px 22px; gap: 13px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid var(--border); }
  .list-row:last-child { border-bottom: none; }
  .list-row:hover { background: var(--surface2); }
  .row-icon { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  .row-info { flex: 1; }
  .row-name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
  .row-sub { font-size: 11px; color: var(--muted); }
  .row-right { text-align: right; }
  .row-val { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; margin-bottom: 2px; }
  .row-val.pos { color: var(--green); }
  .row-val.neg { color: var(--red); }
  .row-val2 { font-size: 11px; color: var(--muted); }

  /* ‚îÄ‚îÄ DEFI DASHBOARD ‚îÄ‚îÄ */
  .defi-hero {
    background: linear-gradient(135deg, var(--surface) 0%, rgba(247,147,26,0.05) 100%);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 32px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }

  .defi-hero::before {
    content: 'DeFi';
    position: absolute;
    right: -20px; top: -20px;
    font-family: 'DM Serif Display', serif;
    font-size: 120px;
    color: rgba(247,147,26,0.04);
    line-height: 1;
    pointer-events: none;
    user-select: none;
  }

  .defi-hero-label { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
  .defi-hero-total { font-family: 'DM Serif Display', serif; font-size: 52px; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .defi-hero-total span { color: var(--orange); }
  .defi-hero-sub { font-size: 13px; color: var(--muted); margin-bottom: 24px; }

  .defi-hero-stats { display: flex; gap: 32px; }
  .defi-hero-stat { }
  .defi-hero-stat-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .defi-hero-stat-val { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; }
  .defi-hero-stat-val.green { color: var(--green); }
  .defi-hero-stat-val.orange { color: var(--orange); }

  /* Position cards */
  .position-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 14px;
    transition: border-color 0.2s, transform 0.15s;
    position: relative;
    overflow: hidden;
  }

  .position-card:hover { border-color: rgba(247,147,26,0.2); transform: translateY(-1px); }

  .position-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--orange);
    border-radius: 14px 0 0 14px;
  }

  .pos-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
  .pos-protocol-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--orange-dim); display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .pos-protocol-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
  .pos-protocol-sub { font-size: 11px; color: var(--muted); }
  .pos-badges { display: flex; gap: 6px; margin-left: auto; }

  .pos-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  .pos-metric-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .pos-metric-val { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; }
  .pos-metric-val.green { color: var(--green); }
  .pos-metric-val.orange { color: var(--orange); }

  /* APY ring */
  .apy-ring {
    display: flex; align-items: center; gap: 8px;
  }

  .ring-wrap {
    position: relative; width: 44px; height: 44px;
  }

  .ring-wrap svg { transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: var(--border); stroke-width: 4; }
  .ring-fill { fill: none; stroke: var(--green); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 1s ease; }

  .ring-label {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    color: var(--green);
  }

  /* Impermanent loss meter */
  .il-meter { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .il-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .il-bar-bg { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .il-bar-fill { height: 100%; background: linear-gradient(90deg, var(--green), #fbbf24); border-radius: 2px; transition: width 1s ease; }
  .il-explain { font-size: 11px; color: var(--muted); margin-top: 6px; line-height: 1.6; }

  /* No positions state */
  .no-positions {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .no-positions-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
  .no-positions-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
  .no-positions-sub { font-size: 13px; line-height: 1.7; max-width: 340px; margin: 0 auto; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (max-width: 680px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .two-col { grid-template-columns: 1fr; }
    .pos-metrics { grid-template-columns: 1fr 1fr; }
    nav { padding: 0 16px; }
    .page { padding: 24px 16px; }
    .defi-hero-stats { gap: 16px; }
    .defi-hero-total { font-size: 36px; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- NAV -->
  <nav>
    <div class="nav-logo">
      <div class="nav-logo-icon">‚Çø</div>
      <div class="nav-logo-text"><span>OP_NET</span></div>
    </div>
    <div class="nav-tabs">
      <div class="nav-tab active" onclick="showPage('wallet')">ü§ñ Wallet Copilot</div>
      <div class="nav-tab" onclick="showPage('defi')">üìä DeFi Dashboard</div>
    </div>
    <div class="nav-right">
      <div class="network-pill connecting" id="networkPill">CONNECTING...</div>
    </div>
  </nav>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- PAGE 1: WALLET COPILOT                                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-wallet">

    <div class="error-bar" id="walletError"></div>

    <label class="input-label">Bitcoin / OP_NET Regtest Address (rBTC)</label>
    <div class="input-row">
      <input class="addr-input" id="walletAddr" placeholder="bcrt1p... (OP_NET regtest Taproot address)"
        onkeydown="if(event.key==='Enter') analyzeWallet()" />
      <button class="btn" id="walletBtn" onclick="analyzeWallet()">Analyze ‚Üí</button>
      <button class="btn btn-ghost" onclick="walletDemo()">Demo</button>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">rBTC Balance</div>
        <div class="stat-val orange" id="w-btc">‚Äî</div>
        <div class="stat-sub" id="w-btc-sub">Enter an address above</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">OP_20 Tokens</div>
        <div class="stat-val green" id="w-tokens">‚Äî</div>
        <div class="stat-sub">Active positions</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Transactions</div>
        <div class="stat-val" id="w-txs">‚Äî</div>
        <div class="stat-sub">On OP_NET regtest</div>
      </div>
    </div>

    <div class="two-col">

      <!-- COPILOT CHAT -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon">ü§ñ</div>
          <div class="card-title">AI Copilot</div>
        </div>
        <div class="chat-msgs" id="chatMsgs">
          <div class="msg bot">
            <div class="msg-av">‚Çø</div>
            <div class="msg-bub">Hey! Enter a regtest address above ‚Äî I'll analyze your rBTC balance, OP_20 tokens, and transaction history, all verified on OP_NET. üîç</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip" onclick="askQ('What is rBTC?')">üí° What is rBTC?</div>
          <div class="chip" onclick="askQ('How does OP_NET verify transactions?')">üîí How it works</div>
          <div class="chip" onclick="askQ('When does mainnet launch?')">üöÄ Mainnet launch?</div>
        </div>
        <div class="chat-bar">
          <input class="chat-in" id="chatIn" placeholder="Ask anything about this wallet..." onkeydown="if(event.key==='Enter') sendMsg()" />
          <button class="send-btn" onclick="sendMsg()">‚Üí</button>
        </div>
      </div>

      <!-- TOKENS -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon">ü™ô</div>
          <div class="card-title">OP_20 Token Holdings</div>
        </div>
        <div id="tokenList"><div class="empty">Enter an address to see token holdings</div></div>
      </div>

    </div>

    <!-- TRANSACTIONS -->
    <div class="full-col">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">‚ö°</div>
          <div class="card-title">Recent Transactions</div>
          <span class="badge badge-purple" style="margin-left:auto;">‚úì CRYPTOGRAPHIC PROOF</span>
        </div>
        <div id="txList"><div class="empty">Enter an address to see transactions</div></div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- PAGE 2: DEFI DASHBOARD                                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-defi">

    <div class="error-bar" id="defiError"></div>

    <label class="input-label">Bitcoin / OP_NET Regtest Address (rBTC)</label>
    <div class="input-row">
      <input class="addr-input" id="defiAddr" placeholder="bcrt1p... (OP_NET regtest Taproot address)"
        onkeydown="if(event.key==='Enter') analyzeDefi()" />
      <button class="btn" id="defiBtn" onclick="analyzeDefi()">Load Positions ‚Üí</button>
      <button class="btn btn-ghost" onclick="defiDemo()">Demo</button>
    </div>

    <!-- Hero total value -->
    <div class="defi-hero">
      <div class="defi-hero-label">Total Portfolio Value</div>
      <div class="defi-hero-total"><span id="d-total">$0</span> <span style="font-size:24px;color:var(--muted);">USD</span></div>
      <div class="defi-hero-sub" id="d-total-sub">Enter an address to load your DeFi positions</div>
      <div class="defi-hero-stats">
        <div class="defi-hero-stat">
          <div class="defi-hero-stat-label">Wallet</div>
          <div class="defi-hero-stat-val orange" id="d-wallet">‚Äî</div>
        </div>
        <div class="defi-hero-stat">
          <div class="defi-hero-stat-label">In DeFi</div>
          <div class="defi-hero-stat-val green" id="d-defi">‚Äî</div>
        </div>
        <div class="defi-hero-stat">
          <div class="defi-hero-stat-label">Positions</div>
          <div class="defi-hero-stat-val" id="d-count">‚Äî</div>
        </div>
        <div class="defi-hero-stat">
          <div class="defi-hero-stat-label">Est. Daily Earn</div>
          <div class="defi-hero-stat-val green" id="d-daily">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Positions -->
    <div id="positionsList">
      <div class="no-positions">
        <div class="no-positions-icon">üìä</div>
        <div class="no-positions-title">No positions loaded</div>
        <div class="no-positions-sub">Enter a regtest address above to see your DeFi positions on OP_NET ‚Äî liquidity pools, staking, and yield.</div>
      </div>
    </div>

  </div>

</div>

<script>
const API = window.location.origin;

// ‚îÄ‚îÄ NETWORK STATUS ‚îÄ‚îÄ
async function checkStatus() {
  try {
    const data = await fetch(`${API}/api/status`).then(r => r.json());
    const pill = document.getElementById('networkPill');
    if (data.connected) {
      pill.className = 'network-pill connected';
      pill.textContent = `${data.network} ¬∑ ${data.currency} ¬∑ #${data.latestBlock}`;
    } else {
      pill.className = 'network-pill disconnected';
      pill.textContent = `${data.network || 'REGTEST'} ¬∑ OFFLINE`;
    }
  } catch {
    const pill = document.getElementById('networkPill');
    pill.className = 'network-pill disconnected';
    pill.textContent = 'SERVER OFFLINE';
  }
}
checkStatus();
setInterval(checkStatus, 30000);

// ‚îÄ‚îÄ PAGE SWITCHING ‚îÄ‚îÄ
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`page-${name}`).classList.add('active');
  event.target.classList.add('active');

  // Sync address between pages
  const walletAddr = document.getElementById('walletAddr').value;
  const defiAddr = document.getElementById('defiAddr').value;
  if (name === 'defi' && walletAddr && !defiAddr) document.getElementById('defiAddr').value = walletAddr;
  if (name === 'wallet' && defiAddr && !walletAddr) document.getElementById('walletAddr').value = defiAddr;
}

// ‚îÄ‚îÄ WALLET COPILOT ‚îÄ‚îÄ
async function analyzeWallet() {
  const address = document.getElementById('walletAddr').value.trim();
  if (!address) { showErr('walletError', 'Please enter an address first.'); return; }
  hideErr('walletError');

  const btn = document.getElementById('walletBtn');
  btn.disabled = true; btn.textContent = 'Loading...';

  document.getElementById('w-btc').textContent = '...';
  document.getElementById('w-tokens').textContent = '...';
  document.getElementById('w-txs').textContent = '...';
  document.getElementById('tokenList').innerHTML = '<div class="empty">Loading tokens...</div>';
  document.getElementById('txList').innerHTML = '<div class="empty">Loading transactions...</div>';

  clearChat(); addMsg('bot', `Analyzing <span class="hi">${shortAddr(address)}</span> on OP_NET Regtest...`);

  try {
    const [bal, tokens, txs] = await Promise.all([
      fetch(`${API}/api/balance/${address}`).then(r => r.json()),
      fetch(`${API}/api/tokens/${address}`).then(r => r.json()),
      fetch(`${API}/api/transactions/${address}`).then(r => r.json()),
    ]);

    const btc = parseFloat(bal.balanceBTC || 0);
    document.getElementById('w-btc').textContent = btc.toFixed(5);
    document.getElementById('w-btc-sub').textContent = `‚âà $${(btc * 98000).toLocaleString()} est.`;
    document.getElementById('w-tokens').textContent = tokens.tokens?.length ?? 0;
    document.getElementById('w-txs').textContent = txs.transactions?.length ?? 0;

    renderTokens(tokens.tokens || []);
    renderTxs(txs.transactions || []);

    if (bal.fallback || txs.fallback) {
      addMsg('bot', `Connected to OP_NET but this address may not have regtest activity yet. <span class="wn">Try the Demo button to see a sample.</span>`);
    } else {
      addMsg('bot', `Loaded! <span class="hi">${btc.toFixed(5)} rBTC</span>, ${tokens.tokens?.length ?? 0} OP_20 tokens, ${txs.transactions?.length ?? 0} transactions ‚Äî <span class="ok">‚úì cryptographically verified</span>. What would you like to know?`);
    }

  } catch (err) {
    showErr('walletError', `Server error: ${err.message}`);
  }

  btn.disabled = false; btn.textContent = 'Analyze ‚Üí';
}

function walletDemo() {
  document.getElementById('walletAddr').value = 'bcrt1plz0svv3wl05qrrv0dx8hvh5mgqc7jf3mhqgtw8jnj3l3d3cs6lzsfc3mxh';
  analyzeWallet();
}

function renderTokens(tokens) {
  const el = document.getElementById('tokenList');
  if (!tokens.length) { el.innerHTML = '<div class="empty">No OP_20 tokens found for this address</div>'; return; }
  el.innerHTML = tokens.map(t => `
    <div class="list-row">
      <div class="row-icon" style="background:${t.color || '#f7931a'}18;color:${t.color || '#f7931a'}">${t.symbol?.[0]}</div>
      <div class="row-info">
        <div class="row-name">${t.name}</div>
        <div class="row-sub">OP_20 ¬∑ ${t.symbol}</div>
      </div>
      <div class="row-right">
        <div class="row-val">${Number(t.balance).toLocaleString()}</div>
        <div class="row-val2">${t.symbol}</div>
      </div>
    </div>
  `).join('');
}

function renderTxs(txs) {
  const el = document.getElementById('txList');
  if (!txs.length) { el.innerHTML = '<div class="empty">No transactions found on OP_NET regtest</div>'; return; }
  el.innerHTML = txs.map(tx => {
    const icons = { contract: 'üîó', receive: '‚Üì', send: '‚Üë' };
    const titles = { contract: 'Smart Contract Call (OP_NET)', receive: 'Received rBTC', send: 'Sent rBTC' };
    const amtClass = tx.type === 'receive' ? 'pos' : 'neg';
    const prefix = tx.type === 'receive' ? '+' : '-';
    const time = tx.timestamp ? new Date(tx.timestamp * 1000).toLocaleDateString() : 'Recent';
    return `
      <div class="list-row">
        <div class="row-icon" style="background:${tx.type==='receive'?'var(--green-dim)':tx.type==='contract'?'rgba(167,139,250,0.1)':'var(--red-dim)'}">
          ${icons[tx.type] || '‚Üí'}
        </div>
        <div class="row-info">
          <div class="row-name">${titles[tx.type] || 'Transaction'}</div>
          <div class="row-sub">${shortTxid(tx.txid)}</div>
        </div>
        <div class="row-right">
          <div class="row-val ${amtClass}">${prefix}${tx.amount} rBTC</div>
          <div class="row-val2">${time}</div>
        </div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ COPILOT CHAT ‚îÄ‚îÄ
const QA = {
  'What is rBTC?': `rBTC stands for <span class="hi">Regtest Bitcoin</span> ‚Äî it's test Bitcoin used on OP_NET's regtest network, which is the final pre-mainnet environment.\n\nrBTC has no real monetary value ‚Äî it's purely for building and testing. When OP_NET launches on Bitcoin mainnet on <span class="hi">March 17, 2026</span>, this will switch to real BTC automatically.`,
  'How does OP_NET verify transactions?': `OP_NET uses <span class="hi">cryptographic proof of correct execution</span>. Every node independently recalculates smart contract results from Bitcoin's raw data.\n\nIf two nodes get different results? That's a protocol bug ‚Äî it cannot happen by design. Unlike BRC-20 or Runes where indexers can disagree, <span class="ok">OP_NET forces mathematical consensus.</span>`,
  'When does mainnet launch?': `OP_NET goes live on Bitcoin mainnet on <span class="hi">March 17, 2026</span> ‚Äî less than a month away!\n\nThis app is already built to support it. When mainnet launches, we change one line in the server code and it switches from rBTC to real BTC. <span class="ok">Your competition build will be live-ready the day it launches. üöÄ</span>`,
};

const fallbacks = [
  `Great question! OP_NET's regtest environment mirrors mainnet conditions closely ‚Äî what you're testing here is essentially what will run on real Bitcoin on March 17.`,
  `This wallet's data is fetched directly from OP_NET nodes and verified cryptographically. No indexer can dispute or alter these results.`,
  `I can analyze any regtest address. If you need test rBTC to play with, check the faucet at faucet.opnet.org!`,
];

let fallbackIdx = 0;

function clearChat() { document.getElementById('chatMsgs').innerHTML = ''; }

function addMsg(role, text) {
  const c = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = `msg ${role}`;
  d.innerHTML = `<div class="msg-av">${role === 'bot' ? '‚Çø' : 'üë§'}</div><div class="msg-bub">${text.replace(/\n/g,'<br>')}</div>`;
  c.appendChild(d);
  c.scrollTop = c.scrollHeight;
}

function showTyping() {
  const c = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.id = 'typing'; d.className = 'msg bot';
  d.innerHTML = `<div class="msg-av">‚Çø</div><div class="msg-bub"><div class="typing"><span></span><span></span><span></span></div></div>`;
  c.appendChild(d); c.scrollTop = c.scrollHeight;
}

function hideTyping() { document.getElementById('typing')?.remove(); }

function askQ(q) {
  addMsg('user', q); showTyping();
  setTimeout(() => {
    hideTyping();
    addMsg('bot', QA[q] || fallbacks[fallbackIdx++ % fallbacks.length]);
  }, 700 + Math.random() * 400);
}

function sendMsg() {
  const inp = document.getElementById('chatIn');
  const val = inp.value.trim();
  if (!val) return;
  inp.value = '';
  askQ(val);
}

// ‚îÄ‚îÄ DEFI DASHBOARD ‚îÄ‚îÄ
async function analyzeDefi() {
  const address = document.getElementById('defiAddr').value.trim();
  if (!address) { showErr('defiError', 'Please enter an address first.'); return; }
  hideErr('defiError');

  const btn = document.getElementById('defiBtn');
  btn.disabled = true; btn.textContent = 'Loading...';

  document.getElementById('d-total').textContent = '...';
  document.getElementById('d-wallet').textContent = '...';
  document.getElementById('d-defi').textContent = '...';
  document.getElementById('d-count').textContent = '...';
  document.getElementById('d-daily').textContent = '...';
  document.getElementById('positionsList').innerHTML = '<div class="no-positions"><div class="no-positions-icon">‚è≥</div><div class="no-positions-title">Loading positions...</div></div>';

  try {
    const [portfolio, defi] = await Promise.all([
      fetch(`${API}/api/portfolio/${address}`).then(r => r.json()),
      fetch(`${API}/api/defi/${address}`).then(r => r.json()),
    ]);

    const totalUSD = parseFloat(portfolio.totalValueUSD || 0);
    const walletUSD = parseFloat(portfolio.walletValueUSD || 0);
    const defiUSD = parseFloat(portfolio.defiValueUSD || 0);
    const positions = defi.positions || [];
    const dailyEarn = positions.reduce((s, p) => s + parseFloat(p.earnings24h || 0), 0);

    document.getElementById('d-total').textContent = `$${totalUSD.toLocaleString(undefined, {maximumFractionDigits:2})}`;
    document.getElementById('d-total-sub').textContent = `${portfolio.currency || 'rBTC'} wallet + ${positions.length} DeFi position${positions.length !== 1 ? 's' : ''} on OP_NET`;
    document.getElementById('d-wallet').textContent = `$${walletUSD.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    document.getElementById('d-defi').textContent = `$${defiUSD.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    document.getElementById('d-count').textContent = positions.length;
    document.getElementById('d-daily').textContent = `$${dailyEarn.toFixed(2)}`;

    renderPositions(positions);

  } catch (err) {
    showErr('defiError', `Could not load positions: ${err.message}`);
    document.getElementById('positionsList').innerHTML = '<div class="no-positions"><div class="no-positions-icon">‚ùå</div><div class="no-positions-title">Could not connect</div><div class="no-positions-sub">Make sure the server is running with npm start</div></div>';
  }

  btn.disabled = false; btn.textContent = 'Load Positions ‚Üí';
}

function defiDemo() {
  document.getElementById('defiAddr').value = 'bcrt1plz0svv3wl05qrrv0dx8hvh5mgqc7jf3mhqgtw8jnj3l3d3cs6lzsfc3mxh';
  analyzeDefi();
}

function renderPositions(positions) {
  const el = document.getElementById('positionsList');

  if (!positions.length) {
    el.innerHTML = `
      <div class="no-positions">
        <div class="no-positions-icon">üå±</div>
        <div class="no-positions-title">No DeFi positions found</div>
        <div class="no-positions-sub">This address hasn't provided liquidity or staked on OP_NET yet. Visit MotoSwap on OP_NET regtest to get started!</div>
      </div>`;
    return;
  }

  el.innerHTML = positions.map(pos => {
    const apy = parseFloat(pos.apy);
    const circumference = 2 * Math.PI * 18;
    const offset = circumference - (Math.min(apy, 100) / 100) * circumference;
    const riskBadge = pos.risk === 'Low' ? 'badge-green' : pos.risk === 'Medium' ? 'badge-orange' : 'badge-red';
    const ilPct = Math.min(apy * 0.3, 30); // rough IL estimate

    return `
      <div class="position-card">
        <div class="pos-header">
          <div class="pos-protocol-icon">üîÑ</div>
          <div>
            <div class="pos-protocol-name">${pos.protocol}</div>
            <div class="pos-protocol-sub">${pos.type} ¬∑ ${pos.pair}</div>
          </div>
          <div class="pos-badges">
            <span class="badge ${riskBadge}">${pos.risk} Risk</span>
            <span class="badge badge-purple">OP_NET</span>
          </div>
        </div>

        <div class="pos-metrics">
          <div>
            <div class="pos-metric-label">Position Value</div>
            <div class="pos-metric-val orange">$${parseFloat(pos.valueUSD).toLocaleString(undefined,{maximumFractionDigits:2})}</div>
          </div>
          <div>
            <div class="pos-metric-label">Est. Daily Earn</div>
            <div class="pos-metric-val green">+$${pos.earnings24h}</div>
          </div>
          <div>
            <div class="pos-metric-label">LP Tokens</div>
            <div class="pos-metric-val">${parseFloat(pos.lpBalance).toFixed(4)}</div>
          </div>
          <div>
            <div class="pos-metric-label">APY</div>
            <div class="apy-ring">
              <div class="ring-wrap">
                <svg width="44" height="44" viewBox="0 0 44 44">
                  <circle class="ring-bg" cx="22" cy="22" r="18"/>
                  <circle class="ring-fill" cx="22" cy="22" r="18"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="${offset}"/>
                </svg>
                <div class="ring-label">${apy}%</div>
              </div>
            </div>
          </div>
        </div>

        <div class="il-meter">
          <div class="il-label">Impermanent Loss Risk</div>
          <div class="il-bar-bg">
            <div class="il-bar-fill" style="width:${ilPct}%"></div>
          </div>
          <div class="il-explain">
            Impermanent loss happens when the prices of your two pooled tokens move apart. At ${apy}% APY, your earnings should outpace typical IL. <span style="color:var(--green)">Currently low risk.</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function shortAddr(a) { return a.slice(0,8) + '...' + a.slice(-6); }
function shortTxid(t) { return t ? t.slice(0,10) + '...' + t.slice(-6) : '‚Äî'; }
function showErr(id, msg) { const e = document.getElementById(id); e.textContent = '‚ö† ' + msg; e.style.display = 'block'; }
function hideErr(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
